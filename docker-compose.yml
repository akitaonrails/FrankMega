services:
  web:
    image: akitaonrails/frankmega:latest
    build: .
    # Port 3100 exposed for local/direct access — primary access is via Cloudflare Tunnel
    ports:
      - "3100:80"
    volumes:
      - uploads:/rails/storage/uploads
      - db_data:/rails/storage
    environment:
      # Required — app will not boot without these
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - RAILS_MASTER_KEY=${RAILS_MASTER_KEY}
      - HOST=${HOST}
      - WEBAUTHN_ORIGIN=${WEBAUTHN_ORIGIN}
      - WEBAUTHN_RP_ID=${WEBAUTHN_RP_ID}
      - ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=${ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY}
      - ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=${ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY}
      - ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=${ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT}
      # Locale: set to pt-BR for Portuguese (default: en)
      - APP_LOCALE=${APP_LOCALE:-en}
      # SSL: defaults to true in production — set to false for local Docker testing without TLS
      - FORCE_SSL=${FORCE_SSL:-true}
      # Storage
      - STORAGE_PATH=/rails/storage/uploads
      - USER_DISK_QUOTA_BYTES=${USER_DISK_QUOTA_BYTES:-5368709120}
      # SMTP (optional — leave blank to disable email delivery)
      - SMTP_ADDRESS=${SMTP_ADDRESS:-localhost}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    restart: unless-stopped

  tunnel:
    image: cloudflare/cloudflared:latest
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    depends_on:
      - web
    restart: unless-stopped

volumes:
  uploads:
  db_data:
